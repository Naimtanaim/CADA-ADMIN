<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è¨—é‹ç°½å–®</title>

<style>
body {
  margin: 0;
  font-family: "PMingLiU","MingLiU","Microsoft JhengHei",serif;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

form {
  width: 30%;
  padding: 20px;
  background: #f5f5f5;
  overflow-y: auto;
  box-sizing: border-box;
}

form h3 { margin-top: 0; }
form .buttons { margin-bottom: 10px; }
form button, form input[type="color"] {
  margin-right: 10px;
  padding: 6px 12px;
  font-size: 14px;
  margin-bottom: 10px;
}

.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 8px;
  flex-wrap: wrap;
}

.form-row label { white-space: nowrap; }
form input { font-size: 14px; padding: 4px; box-sizing: border-box; width: 200px; }

.preview-container {
  width: 70%;
  padding: 20px;
  overflow: auto;
  background: #e0e0e0;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.paper {
  position: relative;
  width: 210mm;
  height: 140mm;
  max-width: 100%;
  background: url("bg.jpg") no-repeat;
  background-size: 210mm 250mm;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

.field { position: absolute; font-size: 15px; white-space: nowrap; }
.date    { top: 13mm; left: 120mm; font-weight: bold; }
.customer { top: 22mm; left: 20mm; font-weight: bold; }
.start_end { top: 40mm; left: 22mm; font-weight: bold; }
.qty   { top: 83mm; left: 20mm; font-weight: bold; }
.board { top: 83mm; left: 43mm; font-weight: bold; }
.weight{ top: 83mm; left: 64mm; font-weight: bold; }
.cbm   { top: 83mm; left: 85mm; font-weight: bold; }
.basic { top: 100mm; left: 30mm; font-weight: bold; }
.extra { top: 100mm; left: 68mm; font-weight: bold; }
.total { top: 110mm; left: 30mm; font-weight: bold; }

/* style umum (opsional) */
.delivery {
  width: 100%;
  padding: 6px 8px;
  font-size: 15px;
  box-sizing: border-box;
}

/* delivery 1 */
.d1 { margin-top: 10px; font-weight: bold; }
/* delivery 2 */
.d2 { margin-top: 10px; font-weight: bold; }
/* delivery 3 */
.d3 { margin-top: 10px; font-weight: bold ; }
/* delivery 4 */
.d4 { margin-top: 10px; font-weight:  bold; }

/* PREVIEW delivery di kertas */
.field.delivery {
  top: 40mm;          
  left: 13mm;
  width: 140mm;
  white-space: normal; 
}

/* tiap baris delivery */
.delivery-line {
  line-height: 1.6;
  min-height: 2.0em; 
  margin-bottom: 6px;
}

@media print {
  body { display: block; }
  form { display: none; }
  .preview-container { width: 100%; padding: 0; background: none; }
  .paper { box-shadow: none; max-width: 100%; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<form id="form">
  <h3>NOTA è¨—é‹ç°½å–®</h3>

  <div class="buttons">
    <button type="button" onclick="updatePaper()">æ›´æ–°å–®æ“š</button>
    <button type="button" onclick="window.print()">åˆ—å°å–®æ“š</button>
    <div class="form-row">
  <label>Area:</label>
  <select id="areaSelect">
    <option value="">-- Pilih Area --</option>
  </select>
</div>

<div class="form-row">
  <label>Truck Type:</label>
  <select id="truckTypeSelect">
    <option value="">-- Pilih Truck --</option>
  </select>
</div>


    <label for="textColor">é¸æ“‡æ–‡å­—é¡è‰²:</label>
    <input type="color" id="textColor" value="#000000">
  </div>

  <div class="form-row">
    <label>æ—¥æœŸ:</label>
    <input type="text" id="year" value=""> å¹´
    <input type="text" id="month" value=""> æœˆ
    <input type="text" id="day" value=""> æ—¥
  </div>

  <div class="form-row">
    <label>é¡§å®¢åç¨±:</label>
    <input type="text" id="customer" value="">
  </div>

  <div class="form-row">
    <label>é…é€å…§å®¹:</label>
    <input type="text" id="delivery1" class="delivery d1">
  </div>
  <div class="form-row">
    <input type="text" id="delivery2" class="delivery d2">
  </div>
  <div class="form-row">
    <input type="text" id="delivery3" class="delivery d3">
  </div>
  <div class="form-row">
    <input type="text" id="delivery4" class="delivery d4">
  </div>

  <div class="form-row">
    <label>æ¿æ•¸:</label>
    <input type="text" id="qty" value="">
    <label>ä»¶æ•¸:</label>
    <input type="text" id="board" value="">
  </div>
  <div class="form-row">
    <label>é‡é‡:</label>
    <input type="text" id="weight" value="">
    <label>æ‰æ•¸:</label>
    <input type="text" id="cbm" value="">
  </div>

  <div class="form-row">
    <label>åŸºæœ¬é‹è²»:</label>
    <input type="text" id="basic" value="">
    <label>ç¸½è¨ˆ:</label>
    <input type="text" id="total" value="">
    <label>é¡å¤–è²»ç”¨:</label>
    <input type="text" id="extra" value="">
  </div>
</form>

<div class="preview-container">
  <div class="paper" id="paper">
    <div class="field date" id="f_date"></div>
    <div class="field customer" id="f_customer"></div>
    <div class="field start_end" id="f_start_end"></div>
    <div class="field delivery" id="f_delivery">
      <div class="delivery-line"></div>
      <div class="delivery-line"></div>
      <div class="delivery-line"></div>
      <div class="delivery-line"></div>
    </div>
    <div class="field board" id="f_board"></div>
    <div class="field qty" id="f_qty"></div>
    <div class="field weight" id="f_weight"></div>
    <div class="field cbm" id="f_cbm"></div>
    <div class="field basic" id="f_basic"></div>
    <div class="field total" id="f_total"></div>
    <div class="field extra" id="f_extra"></div>
    

  </div>
</div>

<script>
const supabaseClient = supabase.createClient(
  'https://uusljhegkvahcjkaxqkz.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g'
);

function num(val) { return parseFloat(val) || 0; }

const deliveryInputs = [
  document.getElementById('delivery1'),
  document.getElementById('delivery2'),
  document.getElementById('delivery3'),
  document.getElementById('delivery4')
];
const f_delivery = document.getElementById('f_delivery');

function updateDeliveryPreview() {
  deliveryInputs.forEach((input, index) => {
    f_delivery.children[index].textContent = input.value || "\u00A0";
  });
}

function updatePaper() {
 f_date.innerHTML = `${year.value}&ensp;&ensp;&ensp;&ensp;&ensp;${month.value}&ensp;&ensp;&ensp;&ensp;&ensp;${day.value}`;
  f_customer.textContent = customer.value;
  f_board.textContent  = board.value;
  f_qty.textContent    = qty.value;
  f_weight.textContent = weight.value;
  f_cbm.textContent    = cbm.value;
  f_basic.textContent  = basic.value;
  f_total.textContent  = total.value;
  f_extra.textContent  = extra.value;
  

  const color = textColor.value;
  document.querySelectorAll('.paper .field').forEach(f => f.style.color = color);

  updateDeliveryPreview();
}

async function loadTotalsFromSupabase() {
  const { data, error } = await supabaseClient
    .from('plt_table_duplicate_total')
    .select('*')
    .single();
  if (!error && data) {
    board.value  = Math.ceil(num(data.total_box));
    qty.value    = Math.ceil(num(data.total_no));
    weight.value = Math.ceil(num(data.total_weight));
    cbm.value    = Math.ceil(num(data.total_cbm));
    basic.value  = Math.ceil(num(data.total_money));  // isi otomatis
    
    // jangan isi extra kalau tidak ada
     basic.value = '';

    // ğŸ”¹ update preview & total
    calcTotal();  // ini akan mengupdate total dan memanggil updatePaper()
  }
}

function calcTotal() {
  const b = Number(basic.value) || 0;
  const e = Number(extra.value) || 0;
  const sum = b + e;

  total.value = sum > 0 ? sum : '';
  updatePaper();
}


function setTodayDate() {
  const today = new Date();
  year.value  = today.getFullYear();
  month.value = String(today.getMonth() + 1).padStart(2, '0');
  day.value   = String(today.getDate()).padStart(2, '0');
  updatePaper();
}



const areaSelect = document.getElementById('areaSelect');
const truckTypeSelect = document.getElementById('truckTypeSelect');

// 1ï¸âƒ£ Load semua area
async function loadAreas() {
  const { data, error } = await supabaseClient
    .from('truck_price')
    .select('area')
    .order('area', { ascending: true });

  if (!error && data) {
    const uniqueAreas = [...new Set(data.map(d => d.area))];
    uniqueAreas.forEach(area => {
      const opt = document.createElement('option');
      opt.value = area;
      opt.textContent = area;
      areaSelect.appendChild(opt);
    });
  }
}

// 2ï¸âƒ£ Load truck_type berdasarkan area
async function loadTruckTypes(area) {
  truckTypeSelect.innerHTML = '<option value="">-- Pilih Truck --</option>';
  if (!area) return;

  const { data, error } = await supabaseClient
    .from('truck_price')
    .select('truck_type')
    .eq('area', area);

  if (!error && data) {
    data.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.truck_type;
      opt.textContent = d.truck_type;
      truckTypeSelect.appendChild(opt);
    });
  }
}

// 3ï¸âƒ£ Ambil harga dari Supabase sesuai truck_type
async function updateTruckPrice() {
  const selectedArea = areaSelect.value;
  const selectedTruck = truckTypeSelect.value;
  if (!selectedArea || !selectedTruck) return;

  const { data, error } = await supabaseClient
    .from('truck_price')
    .select('price')
    .eq('area', selectedArea)
    .eq('truck_type', selectedTruck)
    .limit(1)
    .single();

  if (!error && data) {
    // langsung update harga basic sesuai tabel
    basic.value = data.price;
    calcTotal();

    // update preview truk
    f_truck.textContent = selectedTruck;
  } else {
    basic.value = '';
    f_truck.textContent = 'â€”';
  }
}

// Event listener
areaSelect.addEventListener('change', () => loadTruckTypes(areaSelect.value));
truckTypeSelect.addEventListener('change', updateTruckPrice);


window.addEventListener('DOMContentLoaded', () => {
  loadTotalsFromSupabase(); // load totals dari supabase
  loadAreas();              // load area ke dropdown

  // update preview saat inputan lain berubah
  document.querySelectorAll('#form input').forEach(el => el.addEventListener('input', updatePaper));
  basic.addEventListener('input', calcTotal);
  extra.addEventListener('input', calcTotal);
  textColor.addEventListener('input', updatePaper);
  deliveryInputs.forEach(i => i.addEventListener('input', updateDeliveryPreview));
});


window.addEventListener('DOMContentLoaded', () => {
  setTodayDate();            // â¬…ï¸ TAMBAHKAN INI
  loadTotalsFromSupabase();

  document.querySelectorAll('#form input').forEach(el =>
    el.addEventListener('input', updatePaper)
  );
  basic.addEventListener('input', calcTotal);
  extra.addEventListener('input', calcTotal);
  textColor.addEventListener('input', updatePaper);

  deliveryInputs.forEach(i => i.addEventListener('input', updateDeliveryPreview));
});
</script>
</body>
</html>
