<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å‡ºè²¨èª² - å­˜æ”¾ä½ç½®è³‡æ–™</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
  body { font-family: "Noto Sans TC", sans-serif; margin:0; background:#f6f7f9; padding:18px; }
  .container { max-width:900px; margin:0 auto; }
  .actions { display:flex; justify-content:flex-end; gap:10px; margin-bottom:12px; }
  button { background:#0b6cff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
  button.ghost { background:#fff; color:#0b6cff; border:1px solid #d4d9ef; }
  .sheet { background:white; border-radius:6px; padding:18px; box-shadow:0 6px 18px rgba(10,12,30,0.06); }
  .sheet-header { display:flex; justify-content:space-between; align-items:flex-start; }
  .title-left { font-size:28px; font-weight:700; }
  .meta { font-size:14px; color:#555; }
  .barcode-top svg { width:320px; height:70px; }
  table { width:100%; border-collapse:collapse; margin-top:16px; font-size:14px; }
  th, td { border:1px solid #dfe3ee; padding:8px 10px; text-align:center; }
  th { background:#f9fafc; font-weight:bold; }
  .barcode-thumb svg { height:40px; width:180px; }
  @media print { .actions { display:none; } body { background:white; } .sheet { box-shadow:none; border-radius:0; } }
  .toast { visibility:hidden; min-width:200px; background-color:#333; color:#fff; text-align:center;
           border-radius:8px; padding:12px; position:fixed; left:50%; bottom:30px; 
           opacity:0; transform:translateX(-50%); transition:opacity .5s,bottom .5s; }
  .toast.show { visibility:visible; opacity:1; bottom:50px; }
  .toast.success { background-color:#28a745; }
  .toast.error { background-color:#dc3545; }
</style>
</head>

<body>
<div class="container">
  <div class="actions">
    <input id="placeInput" type="text" placeholder="è¼¸å…¥å­˜æ”¾ä½ç½®" autofocus onkeydown="handleEnter(event)">
    <button onclick="filterByPlace()">æŸ¥è©¢</button>
    <button class="ghost" onclick="refreshData()">åˆ·æ–°è³‡æ–™</button>
    <button onclick="shipAll()">ğŸšš å…¨éƒ¨å‡ºè²¨</button>
    <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
  </div>

  <div class="sheet">
    <div class="sheet-header">
      <div>
        <div class="title-left">å‡ºè²¨èª²</div>
        <div class="meta" style="margin-top:8px;">Print penyimpan å­˜æ”¾ä½ç½®</div>
        <div id="dateNow" class="meta" style="margin-top:6px;"></div>
        <div id="placeLabel" style="margin-top:12px;font-weight:600;color:#111;"></div>
      </div>
      <div class="barcode-top">
        <svg id="mainBarcode"></svg>
      </div>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>No.</th>
          <th>æ¢ç¢¼</th>
          <th>ç®±è™Ÿ</th>
          <th>å…¬å¸è™Ÿ</th>
          <th>åŒ…è£æ•¸é‡</th>
          <th>å®¢æˆ¶</th>
          <th>å®¢æˆ¶è¨‚å–®è™Ÿ</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="7">è«‹è¼¸å…¥å­˜æ”¾ä½ç½®å¾ŒæŸ¥è©¢...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const SUPABASE_URL = "https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.getElementById("dateNow").textContent =
  "æ—¥æœŸï¼š" + new Date().toLocaleDateString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit"});

function makeMainBarcode(text){
  const svg=document.getElementById("mainBarcode");
  svg.innerHTML="";
  JsBarcode(svg,text||"å‡ºè²¨èª²",{format:"CODE128",displayValue:true,height:60,fontSize:14,margin:0});
}
makeMainBarcode("å‡ºè²¨èª²");

function showToast(msg, ok=true){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=`toast show ${ok?'success':'error'}`;
  setTimeout(()=>{ t.className='toast'; },2500);
}

async function refreshData(){
  const {data,error}=await supabase.from("gudang_penyimpanan")
                                   .select("*")
                                   .order("id",{ascending:false})
                                   .limit(10);
  renderTable(data,error);
}

async function filterByPlace(){
  const place=document.getElementById("placeInput").value.trim();
  const tbody=document.getElementById("tableBody");
  const placeLabel=document.getElementById("placeLabel");
  tbody.innerHTML=`<tr><td colspan="7">è¼‰å…¥ä¸­...</td></tr>`;
  placeLabel.textContent="";

  if(!place){
    tbody.innerHTML=`<tr><td colspan="7">âš ï¸ è«‹è¼¸å…¥å­˜æ”¾ä½ç½®</td></tr>`;
    makeMainBarcode("å‡ºè²¨èª²");
    return;
  }

  const {data,error}=await supabase.from("gudang_penyimpanan")
                                   .select("*")
                                   .eq("place",place)
                                   .order("id",{ascending:false});

  placeLabel.textContent="å­˜æ”¾ä½ç½®ï¼š" + place;
  makeMainBarcode(place);
  renderTable(data,error);

  setTimeout(()=>{ document.getElementById("placeInput").value=""; },200);
}

function renderTable(data,error){
  const tbody=document.getElementById("tableBody");
  tbody.innerHTML="";

  if(error){ tbody.innerHTML=`<tr><td colspan="7">âŒ éŒ¯èª¤: ${error.message}</td></tr>`; return; }
  if(!data||data.length===0){ tbody.innerHTML=`<tr><td colspan="7">âš ï¸ æ²’æœ‰æ‰¾åˆ°è³‡æ–™</td></tr>`; return; }

  data.forEach((row,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><div class="barcode-thumb"><svg id="bc-${row.id}"></svg></div><div style="font-size:12px;color:#555;">${row.barcode||""}</div></td>
      <td>${row.box_number||""}</td>
      <td>${row.company_number||""}</td>
      <td>${row.packaging_quantity||""}</td>
      <td>${row.customer||""}</td>
      <td>${row.customer_order_number||""}</td>
    `;
    tbody.appendChild(tr);
    JsBarcode(document.getElementById(`bc-${row.id}`), row.barcode||" ", {format:"CODE128",displayValue:false,height:40,margin:0});
  });
}

async function shipAll(){
  const placeText=document.getElementById("placeLabel").textContent;
  const place=placeText.replace("å­˜æ”¾ä½ç½®ï¼š","");

  if(!place){
    showToast("âš ï¸ è«‹å…ˆæŸ¥è©¢å­˜æ”¾ä½ç½®",false);
    return;
  }

  const {data,error}=await supabase.from("gudang_penyimpanan")
                                   .select("*")
                                   .eq("place",place);

  if(error||!data||data.length===0){
    showToast("âš ï¸ æ²’æœ‰è³‡æ–™å¯å‡ºè²¨",false);
    return;
  }

  // langsung simpan tanpa input
  const items=data.map(d=>({
    barcode:d.barcode,
    box_number:d.box_number,
    company_number:d.company_number,
    packaging_quantity:d.packaging_quantity,
    customer:d.customer,
    customer_order_number:d.customer_order_number,
    shipped_at:new Date().toISOString(),

    preparation_number:d.preparation_number || "",
    delivery_order_number:d.delivery_order_number || "",
    packer:d.packer || "",
    warehouse_location:d.place || ""
  }));

  const {error:insertErr}=await supabase.from("barang_dikirim").insert(items);
  if(insertErr){ showToast("âŒ å„²å­˜å¤±æ•—",false); return; }

  const {error:delErr}=await supabase.from("gudang_penyimpanan").delete().eq("place",place);
  if(delErr){ showToast("âŒ åˆªé™¤åŸå§‹è³‡æ–™å¤±æ•—",false); return; }

  document.getElementById("tableBody").innerHTML=`<tr><td colspan="7">âœ… å…¨éƒ¨å‡ºè²¨å®Œæˆ</td></tr>`;
  showToast("âœ… å·²è‡ªå‹•å‡ºè²¨ (ç„¡éœ€è¼¸å…¥)",true);
}

function handleEnter(e){ if(e.key==="Enter"){ e.preventDefault(); filterByPlace(); } }
</script>
</body>
</html>
