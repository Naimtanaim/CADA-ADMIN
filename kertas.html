<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å‡ºè²¨èª² - å­˜æ”¾ä½ç½®è³‡æ–™</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: "Noto Sans TC", sans-serif; margin:0; background:#f6f7f9; padding:18px; }
.container { max-width:900px; margin:0 auto; }
.actions { display:flex; justify-content:flex-end; gap:10px; margin-bottom:12px; }
button { background:#0b6cff; color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
button.ghost { background:#fff; color:#0b6cff; border:1px solid #d4d9ef; }
.sheet { background:white; border-radius:6px; padding:18px; box-shadow:0 6px 18px rgba(10,12,30,0.06); }
.sheet-header { display:flex; justify-content:space-between; align-items:flex-start; }
.title-left { font-size:28px; font-weight:700; }
.meta { font-size:14px; color:#555; }
.barcode-top svg { width:320px; height:70px; }
table { width:100%; border-collapse:collapse; margin-top:16px; font-size:14px; }
th, td { border:1px solid #dfe3ee; padding:8px 10px; text-align:center; }
th { background:#f9fafc; font-weight:bold; }
.barcode-thumb svg { height:40px; width:180px; }
@media print { .actions { display:none; } body { background:white; } .sheet { box-shadow:none; border-radius:0; } }
.toast { visibility:hidden; min-width:200px; background:#333; color:#fff; text-align:center;
border-radius:8px; padding:12px; position:fixed; left:50%; bottom:30px;
opacity:0; transform:translateX(-50%); transition:.5s; }
.toast.show { visibility:visible; opacity:1; bottom:50px; }
.toast.success { background:#28a745; }
.toast.error { background:#dc3545; }
</style>
</head>

<body>
<div class="container">
  <div class="actions">
    <input id="placeInput" type="text" placeholder="è¼¸å…¥å­˜æ”¾ä½ç½®" autofocus
      onkeydown="handleEnter(event)"
      oninput="this.value=this.value.toUpperCase()">

    <button onclick="filterByPlace()">æŸ¥è©¢</button>
    <button class="ghost" onclick="refreshData()">åˆ·æ–°è³‡æ–™</button>
    <button onclick="shipAll()">ğŸšš å…¨éƒ¨å‡ºè²¨</button>
    <button onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
  </div>

  <div class="sheet">
    <div class="sheet-header">
      <div>
        <div class="title-left">å‡ºè²¨èª²</div>
        <div class="meta">Print penyimpan å­˜æ”¾ä½ç½®</div>
        <div id="dateNow" class="meta"></div>
        <div id="placeLabel" style="margin-top:12px;font-weight:600;"></div>
      </div>
      <div class="barcode-top"><svg id="mainBarcode"></svg></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>No</th><th>æ¢ç¢¼</th><th>ç®±è™Ÿ</th><th>å…¬å¸è™Ÿ</th>
          <th>åŒ…è£æ•¸é‡</th><th>å®¢æˆ¶</th><th>å®¢æˆ¶è¨‚å–®è™Ÿ</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="7">è«‹è¼¸å…¥å­˜æ”¾ä½ç½®å¾ŒæŸ¥è©¢...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= INIT ================= */
document.getElementById("dateNow").textContent =
  "æ—¥æœŸï¼š" + new Date().toLocaleDateString("zh-TW");

/* ================= UTILS ================= */
function handleEnter(e){
  if(e.key==="Enter"){
    e.preventDefault();
    filterByPlace();
  }
}

function toast(msg, ok=true){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=`toast show ${ok?'success':'error'}`;
  setTimeout(()=>t.className="toast",2500);
}

function makeMainBarcode(text){
  const svg=document.getElementById("mainBarcode");
  svg.innerHTML="";
  JsBarcode(svg,text||"å‡ºè²¨èª²",{format:"CODE128",height:60,displayValue:true});
}
makeMainBarcode("å‡ºè²¨èª²");

/* ================= DATA ================= */
async function refreshData(){
  const {data,error}=await supabaseClient
    .from("gudang_penyimpanan")
    .select("*")
    .order("id",{ascending:false})
    .limit(10);
  render(data,error);
}

async function filterByPlace(){
  const place=placeInput.value.trim();
  if(!place){ toast("è«‹è¼¸å…¥å­˜æ”¾ä½ç½®",false); return; }

  const {data,error}=await supabaseClient
    .from("gudang_penyimpanan")
    .select("*")
    .eq("place",place)
    .order("id",{ascending:false});

  placeLabel.textContent="å­˜æ”¾ä½ç½®ï¼š"+place;
  makeMainBarcode(place);
  render(data,error);
  placeInput.value="";
}

function render(data,error){
  const tb=document.getElementById("tableBody");
  tb.innerHTML="";
  if(error){ tb.innerHTML=`<tr><td colspan="7">${error.message}</td></tr>`; return; }
  if(!data.length){ tb.innerHTML=`<tr><td colspan="7">æ²’æœ‰è³‡æ–™</td></tr>`; return; }

  data.forEach((r,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td><svg id="bc${r.id}"></svg><div>${r.barcode||""}</div></td>
        <td>${r.box_number||""}</td>
        <td>${r.company_number||""}</td>
        <td>${r.packaging_quantity||""}</td>
        <td>${r.customer||""}</td>
        <td>${r.customer_order_number||""}</td>
      </tr>`;
    JsBarcode(`#bc${r.id}`,r.barcode||"",{displayValue:false,height:40});
  });
}

async function shipAll(){
  const place=placeLabel.textContent.replace("å­˜æ”¾ä½ç½®ï¼š","");
  if(!place){ toast("è«‹å…ˆæŸ¥è©¢",false); return; }

  const {data}=await supabaseClient
    .from("gudang_penyimpanan")
    .select("*")
    .eq("place",place);

  if(!data.length){ toast("æ²’æœ‰è³‡æ–™",false); return; }

  await supabaseClient.from("barang_dikirim").insert(
    data.map(d=>({...d,shipped_at:new Date()}))
  );

  await supabaseClient.from("gudang_penyimpanan").delete().eq("place",place);
  document.getElementById("tableBody").innerHTML=`<tr><td colspan="7">âœ… å‡ºè²¨å®Œæˆ</td></tr>`;
  toast("å‡ºè²¨æˆåŠŸ");
}
</script>
</body>
</html>
