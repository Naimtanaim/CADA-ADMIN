<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å‡ºè²¨ç´€éŒ„ (Riwayat Barang Keluar)</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
:root{
--primary:#0b6cff;--primary-dark:#084bc9;
--bg:#f3f5fa;--card:#fff;--radius:14px;
--shadow:0 8px 24px rgba(0,0,0,.06)
}
body{font-family:"Noto Sans TC",sans-serif;background:var(--bg);margin:0;padding:20px}
.container{max-width:1100px;margin:auto;padding-bottom:60px}
h1{font-size:30px;font-weight:700;color:#1d2d50;margin-bottom:20px}

.filters{background:var(--card);padding:15px;border-radius:var(--radius);
box-shadow:var(--shadow);display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:22px}
.filters input,.filters button{padding:10px 12px;border-radius:10px;border:1px solid #d0d7e3;font-size:14px}
.filters button{background:var(--primary);border:none;color:#fff;font-weight:600;cursor:pointer}
.filters button:hover{background:var(--primary-dark)}

table{width:100%;border-collapse:collapse;background:var(--card);
border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
th{background:#eef2f8;padding:12px;font-weight:700}
td{padding:12px;border-top:1px solid #eee;font-size:14px}
tr:hover{background:#f7faff}
a{color:var(--primary);font-weight:600}

#detailModal{position:fixed;inset:0;background:rgba(0,0,0,.45);
display:none;justify-content:center;align-items:center;z-index:999}
.modal-content{background:#fff;border-radius:14px;width:860px;max-width:96%;
max-height:88vh;overflow:auto;padding:22px;box-shadow:var(--shadow)}
.modal-header{display:flex;justify-content:space-between;align-items:center;
border-bottom:2px solid #eee;margin-bottom:15px}
.print-btn{background:#198754;color:#fff;border:none;padding:8px 14px;border-radius:8px}
.close-btn{background:#dc3545;color:#fff;border:none;padding:8px 14px;border-radius:8px}

.barcode-thumb svg{height:40px;width:150px}

@media print{
body *{visibility:hidden}
#printArea,#printArea *{visibility:visible}
#printArea{position:absolute;left:0;top:0;width:100%}
#printArea th,#printArea td{border:1px solid #333;padding:4px}
}
</style>
</head>

<body>
<div class="container">
<h1>å‡ºè²¨ç´€éŒ„ç¸½è¦½</h1>

<div class="filters">
<input id="customerSearch" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±">
<label>å‡ºè²¨æ—¥æœŸï¼š</label>
<input type="date" id="dateFrom">
<span>ï½</span>
<input type="date" id="dateTo">
<button onclick="applyFilters()">æŸ¥è©¢</button>
<button onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
</div>

<table>
<thead>
<tr><th>No</th><th>å‡ºè²¨å–®è™Ÿ</th><th>å®¢æˆ¶</th><th>å‡ºè²¨æ—¥æœŸ</th></tr>
</thead>
<tbody id="summaryBody">
<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>
</tbody>
</table>
</div>

<div id="detailModal">
<div class="modal-content">
<div class="modal-header">
<span id="detailTitle">å‡ºè²¨æ˜ç´°</span>
<div>
<button class="print-btn" onclick="printDetail()">ğŸ–¨ï¸ åˆ—å°</button>
<button class="close-btn" onclick="closeModal()">é—œé–‰</button>
</div>
</div>
<div id="detailContent"></div>
</div>
</div>

<div id="printArea" style="display:none"></div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL="https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
const supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

/* ================= LOAD ================= */
async function refreshData(){
const tb=document.getElementById("summaryBody");
tb.innerHTML="<tr><td colspan='4'>è¼‰å…¥ä¸­...</td></tr>";

const {data,error}=await supabaseClient
.from("barang_dikirim")
.select("*")
.order("shipped_at",{ascending:false});

if(error){tb.innerHTML=`<tr><td colspan='4'>${error.message}</td></tr>`;return;}
renderSummary(data);
}

/* ================= FILTER ================= */
async function applyFilters(){
let q=supabaseClient.from("barang_dikirim").select("*");
const name=customerSearch.value.trim();
if(name) q=q.ilike("customer",`%${name}%`);
if(dateFrom.value) q=q.gte("shipped_at",dateFrom.value);
if(dateTo.value) q=q.lte("shipped_at",dateTo.value+"T23:59:59");

const {data,error}=await q.order("shipped_at",{ascending:false});
if(error){alert(error.message);return;}
renderSummary(data);
}

/* ================= SUMMARY ================= */
function renderSummary(data){
const tb=document.getElementById("summaryBody");
tb.innerHTML="";
if(!data.length){tb.innerHTML="<tr><td colspan='4'>æ²’æœ‰è³‡æ–™</td></tr>";return;}

const grouped={};
data.forEach(d=>{
const key=d.customer_order_number||"æœªæŒ‡å®š";
(grouped[key]=grouped[key]||[]).push(d);
});

Object.entries(grouped).forEach(([order,rows],i)=>{
const d=rows[0];
tb.innerHTML+=`
<tr>
<td>${i+1}</td>
<td><a href="#" onclick="showDetail('${order}')">${order}</a></td>
<td>${d.customer||""}</td>
<td>${new Date(d.shipped_at).toLocaleString("zh-TW")}</td>
</tr>`;
});
}

/* ================= DETAIL ================= */
async function showDetail(order){
const {data,error}=await supabaseClient
.from("barang_dikirim")
.select("*")
.eq("customer_order_number",order);

if(error){alert(error.message);return;}

const table=`
<table>
<thead><tr>
<th>No</th><th>æ¢ç¢¼</th><th>ç®±è™Ÿ</th><th>å…¬å¸è™Ÿ</th>
<th>åŒ…è£</th><th>è¨‚å–®</th><th>å‚™æ–™</th><th>é€è²¨</th><th>æ‰“åŒ…</th><th>å€‰åº«</th>
</tr></thead>
<tbody>
${data.map((d,i)=>`
<tr>
<td>${i+1}</td>
<td><div class="barcode-thumb" id="bc${i}"></div>${d.barcode||""}</td>
<td>${d.box_number||""}</td>
<td>${d.company_number||""}</td>
<td>${d.packaging_quantity||""}</td>
<td>${d.customer_order_number||""}</td>
<td>${d.preparation_number||""}</td>
<td>${d.delivery_order_number||""}</td>
<td>${d.packer||""}</td>
<td>${d.warehouse_location||""}</td>
</tr>`).join("")}
</tbody></table>`;

detailContent.innerHTML=table;
printArea.innerHTML=table;
detailTitle.textContent="å‡ºè²¨æ˜ç´°ï¼š"+order;
detailModal.style.display="flex";

data.forEach((d,i)=>{
const div=document.getElementById(`bc${i}`);
const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
div.appendChild(svg);
JsBarcode(svg,d.barcode||" ",{displayValue:false,height:40});
});
}

/* ================= ACTION ================= */
function printDetail(){
printArea.style.display="block";
setTimeout(()=>{window.print();printArea.style.display="none"},300);
}
function closeModal(){detailModal.style.display="none"}

refreshData();
</script>
</body>
</html>
