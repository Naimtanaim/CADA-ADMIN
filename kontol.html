<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å‡ºè²¨ç´€éŒ„ (Riwayat Barang Keluar)</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
    :root {
        --primary: #0b6cff;
        --primary-dark: #084bc9;
        --bg: #f3f5fa;
        --card-bg: #ffffff;
        --radius: 14px;
        --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    body {
        font-family: "Noto Sans TC", sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        color: #333;
    }

    .container {
        max-width: 1100px;
        margin: 0 auto;
        padding-bottom: 60px;
    }

    h1 {
        font-size: 30px;
        margin-bottom: 20px;
        font-weight: 700;
        color: #1d2d50;
        letter-spacing: 1px;
    }

    /* Filter Section */
    .filters {
        background: var(--card-bg);
        padding: 15px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 22px;
    }

    .filters input, .filters button {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d0d7e3;
        font-size: 14px;
    }

    .filters input {
        background: #f9fafc;
    }

    .filters button {
        background: var(--primary);
        border: none;
        color: white;
        font-weight: 600;
        transition: 0.2s;
        cursor: pointer;
    }

    .filters button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Summary Table */
    table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    th {
        background: #eef2f8;
        padding: 12px;
        font-size: 15px;
        font-weight: 700;
        color: #1a2b48;
    }

    td {
        padding: 12px;
        border-top: 1px solid #eee;
        font-size: 14px;
    }

    tr:hover {
        background: #f7faff;
    }

    a {
        font-weight: 600;
        color: var(--primary);
    }

    a:hover {
        text-decoration: underline;
    }

    /* Modal */
    #detailModal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 999;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: var(--card-bg);
        box-shadow: var(--shadow);
        border-radius: var(--radius);
        width: 860px;
        max-width: 96%;
        max-height: 88vh;
        overflow-y: auto;
        padding: 22px;
        animation: slideUp 0.25s ease-out;
    }

    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f2f7;
        margin-bottom: 15px;
    }

    .modal-header span {
        font-weight: 700;
        font-size: 20px;
        color: #1d2d50;
    }

    .print-btn, .close-btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
    }

    .print-btn {
        background: #198754;
        color: white;
    }

    .print-btn:hover {
        background: #146c43;
    }

    .close-btn {
        background: #dc3545;
        color: white;
    }

    .close-btn:hover {
        background: #b02a37;
    }

    /* Modal table */
    .modal-content table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .modal-content th, .modal-content td {
        border: 1px solid #cfd6e4;
        padding: 8px;
        font-size: 13px;
    }

    .modal-content th {
        background: #f4f6fb;
        font-weight: 700;
    }

    .barcode-thumb svg {
        height: 40px;
        width: 150px;
    }

    /* Print styles */
    @media print {
        body * { visibility: hidden; }
        #printArea, #printArea * { visibility: visible; }
        #printArea {
            position: absolute;
            left: 0; top: 0;
            width: 100%;
            padding: 10px;
            font-size: 12px;
        }
        #printArea table {
            border-collapse: collapse;
            width: 100%;
        }
        #printArea th, #printArea td {
            border:1px solid #333;
            padding:4px;
        }
    }
</style>
</head>

<body>

<div class="container">
    <h1>å‡ºè²¨ç´€éŒ„ç¸½è¦½</h1>

    <div class="filters">
        <input type="text" id="customerSearch" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±">
        <label>å‡ºè²¨æ—¥æœŸï¼š</label>
        <input type="date" id="dateFrom">
        <span>ï½</span>
        <input type="date" id="dateTo">
        <button onclick="applyFilters()">æŸ¥è©¢</button>
        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
    </div>

    <table id="summaryTable">
        <thead>
            <tr>
                <th>No.</th>
                <th>å‡ºè²¨å–®è™Ÿ</th>
                <th>å®¢æˆ¶</th>
                <th>å‡ºè²¨æ—¥æœŸ</th>
            </tr>
        </thead>
        <tbody id="summaryBody">
            <tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
    </table>
</div>

<!-- Modal Detail -->
<div id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="detailTitle">å‡ºè²¨æ˜ç´°</span>
            <div>
                <button class="print-btn" onclick="printDetail()">ğŸ–¨ï¸ åˆ—å°</button>
                <button class="close-btn" onclick="closeModal()">é—œé–‰</button>
            </div>
        </div>
        <div id="detailContent"></div>
    </div>
</div>

<!-- Print Area -->
<div id="printArea" style="display:none;"></div>

<script>

const SUPABASE_URL = "https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


// Load summary
async function refreshData() {
    const tbody = document.getElementById("summaryBody");
    tbody.innerHTML = `<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>`;

    const { data, error } = await supabase
        .from("barang_dikirim")
        .select("*")
        .order("shipped_at", { ascending: false });

    if (error) {
        tbody.innerHTML = `<tr><td colspan="4">âŒ ${error.message}</td></tr>`;
        return;
    }

    renderSummary(data);
}


// Apply filter
async function applyFilters() {
    const name = document.getElementById("customerSearch").value.trim();
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;

    let query = supabase.from("barang_dikirim").select("*");

    if (name) query = query.ilike("customer", `%${name}%`);
    if (dateFrom) query = query.gte("shipped_at", dateFrom);
    if (dateTo) query = query.lte("shipped_at", dateTo + "T23:59:59");

    const { data, error } = await query.order("shipped_at", { ascending: false });

    if (error) {
        alert("æœå°‹éŒ¯èª¤: " + error.message);
        return;
    }

    renderSummary(data);
}


// Render summary
function renderSummary(data) {

    const tbody = document.getElementById("summaryBody");
    tbody.innerHTML = "";

    if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">âš ï¸ æ²’æœ‰è³‡æ–™</td></tr>`;
        return;
    }

    const grouped = {};

    data.forEach(d => {
        const key = d.customer_order_number || "æœªæŒ‡å®š";
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(d);
    });

    Object.entries(grouped).forEach(([orderNo, rows], idx) => {
        const first = rows[0];
        const date = first.shipped_at
            ? new Date(first.shipped_at).toLocaleString("zh-TW")
            : "";

        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td><a href="#" onclick="showDetail('${orderNo}')">${orderNo}</a></td>
            <td>${first.customer || ""}</td>
            <td>${date}</td>
        `;

        tbody.appendChild(tr);
    });
}


// Show detail modal
function showDetail(orderNo) {

    supabase.from("barang_dikirim")
        .select("*")
        .eq("customer_order_number", orderNo)
        .then(({ data, error }) => {

            if (error) {
                alert("è¼‰å…¥éŒ¯èª¤: " + error.message);
                return;
            }

            const htmlTable = `
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>æ¢ç¢¼</th>
                        <th>ç®±è™Ÿ</th>
                        <th>å…¬å¸è™Ÿ</th>
                        <th>åŒ…è£æ•¸é‡</th>
                        <th>å®¢æˆ¶è¨‚å–®è™Ÿ</th>
                        <th>å‚™æ–™å–®è™Ÿ</th>
                        <th>é€è²¨è¨‚å–®è™Ÿ</th>
                        <th>æ‰“åŒ…äººå“¡</th>
                        <th>å€‰åº«ä½ç½®</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((d, i) => `
                        <tr>
                            <td>${i + 1}</td>
                            <td>
                                <div class="barcode-thumb" id="print-bc-${i}"></div>
                                <div>${d.barcode || ""}</div>
                            </td>
                            <td>${d.box_number || ""}</td>
                            <td>${d.company_number || ""}</td>
                            <td>${d.packaging_quantity || ""}</td>
                            <td>${d.customer_order_number || ""}</td>
                            <td>${d.preparation_number || ""}</td>
                            <td>${d.delivery_order_number || ""}</td>
                            <td>${d.packer || ""}</td>
                            <td>${d.warehouse_location || ""}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>`;

            document.getElementById("detailContent").innerHTML = htmlTable;
            document.getElementById("detailTitle").textContent = `å‡ºè²¨æ˜ç´°ï¼š${orderNo}`;
            document.getElementById("detailModal").style.display = "flex";

            // Print Area
            const printArea = document.getElementById("printArea");
            printArea.innerHTML = htmlTable;

            // Generate barcode
            data.forEach((d, i) => {
                const div = document.getElementById(`print-bc-${i}`);
                if (div) {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    div.appendChild(svg);
                    JsBarcode(svg, d.barcode || " ", {
                        format: "CODE128",
                        displayValue: false,
                        height: 40,
                        margin: 0
                    });
                }
            });

        });
}


// Print detail
function printDetail() {
    const printArea = document.getElementById("printArea");
    printArea.style.display = "block";

    setTimeout(() => {
        window.print();
        printArea.style.display = "none";
    }, 300);
}


// Close modal
function closeModal() {
    document.getElementById("detailModal").style.display = "none";
}


// Initial load
refreshData();

</script>

</body>
</html>
