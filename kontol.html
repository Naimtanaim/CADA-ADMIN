<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å‡ºè²¨ç´€éŒ„ (Riwayat Barang Keluar)</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: "Noto Sans TC", sans-serif; background: #f7f9fc; padding: 20px; margin: 0; }
.container { max-width: 1000px; margin: 0 auto; }
h1 { font-size: 26px; margin-bottom: 20px; }

table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: center; font-size: 14px; }
th { background: #f2f4f7; }
a { color: #0b6cff; text-decoration: none; font-weight: 600; cursor:pointer; }
a:hover { text-decoration: underline; }

.filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
input, button { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit; }
button { background: #0b6cff; color: white; border: none; font-weight: 600; cursor: pointer; }
button:hover { background: #084bc9; }

#detailModal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 9999; }
.modal-content { background: white; padding: 20px; border-radius: 10px; width: 800px; max-width: 95%; max-height: 85vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.print-btn, .close-btn { padding: 6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:13px; font-weight:600; }
.print-btn { background:#198754; color:white; margin-right:6px; }
.print-btn:hover { background:#146c43; }
.close-btn { background:#dc3545; color:white; }
.close-btn:hover { background:#a71d2a; }

.modal-content table { width: 100%; border-collapse: collapse; font-size: 13px; }
.modal-content th, .modal-content td { border:1px solid #333; padding: 6px; text-align: center; }
.barcode-thumb svg { height: 40px; width: 150px; }

/* Print styles */
@media print {
  body * { visibility: hidden; }
  #printArea, #printArea * { visibility: visible; }
  #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 10px; font-size: 12px; }
  #printArea table { border-collapse: collapse; width: 100%; }
  #printArea th, #printArea td { border:1px solid #333; padding:4px; text-align:center; font-size:12px; }
  #printArea h2 { margin-bottom:10px; }
  .barcode-thumb svg { height:40px; width:150px; }
}
</style>
</head>
<body>

<div class="container">
  <h1>å‡ºè²¨ç´€éŒ„ç¸½è¦½</h1>
  <div class="filters">
    <input type="text" id="customerSearch" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±">
    <label>å‡ºè²¨æ—¥æœŸï¼š</label>
    <input type="date" id="dateFrom">
    <span>ï½</span>
    <input type="date" id="dateTo">
    <button onclick="applyFilters()">æŸ¥è©¢</button>
    <button onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
  </div>

  <table id="summaryTable">
    <thead>
      <tr>
        <th>No.</th>
        <th>å‡ºè²¨å–®è™Ÿ</th>
        <th>å®¢æˆ¶</th>
        <th>å‡ºè²¨æ—¥æœŸ</th>
      </tr>
    </thead>
    <tbody id="summaryBody">
      <tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal Detail -->
<div id="detailModal">
  <div class="modal-content">
    <div class="modal-header">
      <span id="detailTitle">å‡ºè²¨æ˜ç´°</span>
      <div>
        <button class="print-btn" onclick="printDetail()">ğŸ–¨ï¸ åˆ—å°</button>
        <button class="close-btn" onclick="closeModal()">é—œé–‰</button>
      </div>
    </div>
    <div id="detailContent"></div>
  </div>
</div>

<!-- Print Area -->
<div id="printArea" style="display:none;"></div>

<script>
const SUPABASE_URL = "https://uusljhegkvahcjkaxqkz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1c2xqaGVna3ZhaGNqa2F4cWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODMzMTIsImV4cCI6MjA3MDA1OTMxMn0.eio4OSjH30XzfXn-9UxQRVwleGKi2dvdWo6Ggx8FW1g";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Refresh summary
async function refreshData() {
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = `<tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr>`;
  const { data, error } = await supabase.from("barang_dikirim").select("*").order("shipped_at",{ascending:false});
  if(error){ tbody.innerHTML = `<tr><td colspan="4">âŒ ${error.message}</td></tr>`; return; }
  renderSummary(data);
}

// Apply filter
async function applyFilters() {
  const name = document.getElementById("customerSearch").value.trim();
  const dateFrom = document.getElementById("dateFrom").value;
  const dateTo = document.getElementById("dateTo").value;
  let query = supabase.from("barang_dikirim").select("*");
  if(name) query = query.ilike("customer", `%${name}%`);
  if(dateFrom) query = query.gte("shipped_at", dateFrom);
  if(dateTo) query = query.lte("shipped_at", dateTo + "T23:59:59");
  const { data, error } = await query.order("shipped_at",{ascending:false});
  if(error){ alert("æœå°‹éŒ¯èª¤: "+error.message); return; }
  renderSummary(data);
}

// Render summary table
function renderSummary(data){
  const tbody = document.getElementById("summaryBody");
  tbody.innerHTML = "";
  if(!data || data.length===0){ tbody.innerHTML = `<tr><td colspan="4">âš ï¸ æ²’æœ‰è³‡æ–™</td></tr>`; return; }

  const grouped = {};
  data.forEach(d => {
    const key = d.customer_order_number || "æœªæŒ‡å®š";
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(d);
  });

  Object.entries(grouped).forEach(([orderNo, rows], idx)=>{
    const first = rows[0];
    const date = first.shipped_at ? new Date(first.shipped_at).toLocaleString("zh-TW") : "";
    const tr = document.createElement("tr");
    
    const tdNo = document.createElement("td"); tdNo.textContent = idx+1; tr.appendChild(tdNo);

    const tdOrder = document.createElement("td");
    const link = document.createElement("a");
    link.textContent = orderNo;
    link.href="#";
    link.addEventListener("click", e=>{ e.preventDefault(); showDetail(orderNo); });
    tdOrder.appendChild(link);
    tr.appendChild(tdOrder);

    const tdCustomer = document.createElement("td"); tdCustomer.textContent = first.customer||""; tr.appendChild(tdCustomer);
    const tdDate = document.createElement("td"); tdDate.textContent = date; tr.appendChild(tdDate);

    tbody.appendChild(tr);
  });
}

// Show detail modal + barcode
function showDetail(orderNo){
  supabase.from("barang_dikirim").select("*").eq("customer_order_number", orderNo)
    .then(({data,error})=>{
      if(error){ alert("è¼‰å…¥éŒ¯èª¤: "+error.message); return; }

      const htmlTable = `
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>æ¢ç¢¼</th>
              <th>ç®±è™Ÿ</th>
              <th>å…¬å¸è™Ÿ</th>
              <th>åŒ…è£æ•¸é‡</th>
              <th>å®¢æˆ¶è¨‚å–®è™Ÿ</th>
            </tr>
          </thead>
          <tbody>
            ${data.map((d,i)=>`
              <tr>
                <td>${i+1}</td>
                <td><div class="barcode-thumb" id="print-bc-${i}"></div><div>${d.barcode||""}</div></td>
                <td>${d.box_number||""}</td>
                <td>${d.company_number||""}</td>
                <td>${d.packaging_quantity||""}</td>
                <td>${d.customer_order_number||""}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>`;

      document.getElementById("detailContent").innerHTML = htmlTable;
      document.getElementById("detailModal").style.display = "flex";
      document.getElementById("detailTitle").textContent = `å‡ºè²¨æ˜ç´°ï¼š${orderNo}`;

      // Print area
      const printArea = document.getElementById("printArea");
      printArea.innerHTML = htmlTable;

      // Generate barcode di print area
      data.forEach((d,i)=>{
        const div = document.getElementById(`print-bc-${i}`);
        if(div){
          const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
          div.appendChild(svg);
          JsBarcode(svg, d.barcode || " ", {format:"CODE128", displayValue:false, height:40, margin:0});
        }
      });
    });
}

function printDetail(){
  const printArea = document.getElementById("printArea");
  printArea.style.display = "block";
  setTimeout(()=>{
    window.print();
    printArea.style.display = "none";
  }, 300);
}

function closeModal(){ document.getElementById("detailModal").style.display="none"; }

refreshData();
</script>
</body>
</html>
